
SQL, как и любой другой язык программирования, предоставляет функции и хранимые процедуры. В этой статье мы рассмотрим функции и хранимые процедуры в PostgreSQL, а также будут освещены следующие моменты:

- что такое функции и хранимые процедуры;
  
- разница между функциями и хранимыми процедурами;  

- создание функций и хранимых процедур;  

- применение функций и хранимых процедур в реальных примерах.  


Функции и хранимые процедуры в SQL, как и в любом другом языке программирования, обеспечивают возможность повторного использования и гибкость. Функции и хранимые процедуры представляют собой блок кода или запросов, хранящихся в базе данных, которые можно использовать снова и снова. Вместо того чтобы писать одни и те же запросы, удобнее сгруппировать все запросы и сохранить их, чтобы можно было использовать их много раз. Что касается гибкости, то всякий раз, когда происходит изменение логики запросов, можно передавать новый параметр функциям и хранимым процедурам.

Между функциями и хранимыми процедурами в PostgreSQL есть несколько различий. Они показаны в таблице ниже.

| **Функции**                                                                                                               | **Хранимые процедуры**                                                             |
| ------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------- |
| Функция имеет возвращаемый тип и возвращает значение                                                                      | Хранимая процедура не имеет возвращаемого типа, но имеет выходные аргументы        |
| Использование DML (insert, update, delete) запросов внутри функции невозможно. В функциях разрешены только SELECT-запросы | Использование DML-запросов (insert, update, delete) возможно в хранимой процедуре. |
| Функция не имеет выходных аргументов                                                                                      | Хранимая процедура имеет и входные, и выходные аргументы                           |
| Вызов хранимой процедуры из функции невозможно                                                                            | Использование или же управление транзакциями возможно в хранимой процедуре         |
| Вызов функции внутри `SELECT` запросов возможен                                                                           | Вызов хранимой процедуры из `SELECT` запросов невозможно                           |

---
# ФУНКЦИЯ

Давайте рассмотрим создание функции в PostgreSQL. Следующий блок кода иллюстрирует, как создавать функцию.

```sql

CREATE [or REPLACE] FUNCTION function_name(param_list)
   RETURNS return_type 
   LANGUAGE plpgsql
  as
$$
DECLARE 
-- variable declaration
BEGIN
 -- logic
END;
$$

```

Оператор:

- `create [or replace] function имя_функции` — создает или заменяет функцию, если она существует, с заданным именем и параметрами;
  
- `returns return_type` — тип данных, который возвращает функция;  

- язык plpgsql — указывает на процедурное расширение PostgreSQL;  

- внутри знака `$` является телом функции;  

- `declare` — показывает, как объявляются или инициализируются переменные;  

- блок кода `[begin — end]` — содержит всю логику функции;  

- `begin` — указывает на начало запросов;  

- `end` — указывает конец функции.  


В следующем блоке кода показано создание простой функции, которая вычисляет стоимость самой дорогой покупки определенного пользователя.

```sql

CREATE OR REPLACE FUNCTION findMostExpensivePurchase(customer_id int)
    RETURNS numeric(10, 2)
    LANGUAGE plpgsql
AS
$$
DECLARE
    itemCost numeric(10, 2);
begin
    SELECT MAX(cost)
    INTO itemCost
    FROM purchases
    WHERE user_id = customer_id;
    RETURN itemCost;
end;
$$;

```

Важно отметить:

- `Declare itemCost integer` — объявляем локальную переменную;
  
- `SELECT ax(cost) INTO itemCost` — как мы инициализируем переменную itemCost;  
    
- `RETURN itemCost` — возвращает значение функции.  

---
# ХРАНИМАЯ ПРОЦЕДУРА

Создание хранимой процедуры, как показано в блоке кода ниже, почти такое же, как создание функции с небольшим отличием — в ней нет `return`. Остальное почти идентично.

```sql

CREATE [OR REPLACE] PROCEDURE procedure_name(parameter_list)
LANGUAGE language_name
AS $
    stored_procedure_body;
$;

```

В приведенном ниже блоке кода показано создание процедуры — `transfer()`, которая принимает три параметра. Сразу после имени процедуры передаются аргументы с соответствующими типами данных — `sourceAccountId`, `destinationAccountId`, сумма. Процедура вычитает переданную сумму из одного `account` и добавляет ее к другому `account`.

```sql

CREATE OR REPLACE PROCEDURE transfer(sourceAccountId bigInt, destinationAccountId bigInt, amount Integer)
language plpgsql
as $$
begin
    update accounts
    set balance = accounts.balance - amount
    where id = sourceAccountId;

    update accounts
    set balance = balance + amount
    where id = destinationAccountId;

    commit;
end;
$$;

```

Там дальше в [статье](https://proglib.io/p/funkcii-i-hranimye-procedury-v-sql-zachem-nuzhny-i-kak-primenyat-v-realnyh-primerah-2022-10-07) использование, можете глянуть.